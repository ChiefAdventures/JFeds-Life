name: Sync Notion to GitHub

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Create sync script
        run: |
          cat > sync.js << 'EOF'
          const https = require('https');
          const fs = require('fs');
          const path = require('path');

          const NOTION_TOKEN = process.env.NOTION_TOKEN;
          const DATABASE_ID = process.env.NOTION_DATABASE_ID;

          function notionRequest(endpoint, method = 'GET', body = null) {
            return new Promise((resolve, reject) => {
              const options = {
                hostname: 'api.notion.com',
                port: 443,
                path: endpoint,
                method: method,
                headers: {
                  'Authorization': `Bearer ${NOTION_TOKEN}`,
                  'Notion-Version': '2022-06-28',
                  'Content-Type': 'application/json'
                }
              };

              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', (chunk) => { data += chunk; });
                res.on('end', () => {
                  if (res.statusCode >= 200 && res.statusCode < 300) {
                    resolve(JSON.parse(data));
                  } else {
                    reject(new Error(`HTTP ${res.statusCode}: ${data}`));
                  }
                });
              });

              req.on('error', reject);
              
              if (body) {
                req.write(JSON.stringify(body));
              }
              
              req.end();
            });
          }

          async function getBlocks(blockId) {
            return notionRequest(`/v1/blocks/${blockId}/children`);
          }

          async function queryDatabase(databaseId) {
            return notionRequest(`/v1/databases/${databaseId}/query`, 'POST', {});
          }

          function blocksToMarkdown(blocks) {
            let markdown = '';
            
            for (const block of blocks) {
              const type = block.type;
              
              if (type === 'paragraph' && block.paragraph.rich_text) {
                const text = block.paragraph.rich_text.map(t => t.plain_text).join('');
                markdown += text + '\n\n';
              } else if (type === 'heading_1' && block.heading_1.rich_text) {
                const text = block.heading_1.rich_text.map(t => t.plain_text).join('');
                markdown += '# ' + text + '\n\n';
              } else if (type === 'heading_2' && block.heading_2.rich_text) {
                const text = block.heading_2.rich_text.map(t => t.plain_text).join('');
                markdown += '## ' + text + '\n\n';
              } else if (type === 'heading_3' && block.heading_3.rich_text) {
                const text = block.heading_3.rich_text.map(t => t.plain_text).join('');
                markdown += '### ' + text + '\n\n';
              } else if (type === 'bulleted_list_item' && block.bulleted_list_item.rich_text) {
                const text = block.bulleted_list_item.rich_text.map(t => t.plain_text).join('');
                markdown += '- ' + text + '\n';
              } else if (type === 'numbered_list_item' && block.numbered_list_item.rich_text) {
                const text = block.numbered_list_item.rich_text.map(t => t.plain_text).join('');
                markdown += '1. ' + text + '\n';
              }
            }
            
            return markdown;
          }

          async function sync() {
            try {
              console.log('Querying database...');
              const response = await queryDatabase(DATABASE_ID);
              
              console.log('Found', response.results.length, 'pages');

              for (const page of response.results) {
                const props = page.properties;
                
                const title = props.Title?.title?.[0]?.plain_text || 
                              props.Name?.title?.[0]?.plain_text || 
                              'Untitled';
                
                const folder = props.Folder?.select?.name || 
                               props.Folder?.rich_text?.[0]?.plain_text ||
                               'faith_life';
                
                const date = props.Date?.date?.start || page.created_time;

                console.log('Processing:', title);

                const blocksResponse = await getBlocks(page.id);
                const content = blocksToMarkdown(blocksResponse.results);

                const frontmatterLines = [
                  '---',
                  'title: "' + title.replace(/"/g, '\\"') + '"',
                  'date: ' + date,
                  '---',
                  ''
                ];
                const frontmatter = frontmatterLines.join('\n');
                const fullContent = frontmatter + '\n' + content;

                const dirPath = path.join(folder);
                if (!fs.existsSync(dirPath)) {
                  fs.mkdirSync(dirPath, { recursive: true });
                }

                const filename = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const filepath = path.join(dirPath, filename + '.md');

                fs.writeFileSync(filepath, fullContent);
                console.log('Created:', filepath);
              }

              console.log('Sync complete!');
            } catch (error) {
              console.error('Error:', error.message);
              process.exit(1);
            }
          }

          sync();
          EOF

      - name: Run sync script
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: node sync.js

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git diff --quiet && git diff --staged --quiet || (git commit -m "Sync from Notion" && git push)
