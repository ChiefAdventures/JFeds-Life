name: Sync Notion to Website

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install @notionhq/client

      - name: Create sync script
        run: |
          node -e "
          const { Client } = require('@notionhq/client');
          const fs = require('fs');
          
          const notion = new Client({ auth: process.env.NOTION_TOKEN });
          const dbId = process.env.NOTION_DATABASE_ID.replace(/-/g, '').replace(/^(.{8})(.{4})(.{4})(.{4})(.{12})$/, '\$1-\$2-\$3-\$4-\$5');
          
          (async () => {
            try {
              console.log('Querying database:', dbId);
              const response = await notion.databases.query({
                database_id: dbId,
                filter: { property: 'Published', checkbox: { equals: true } }
              });
              
              console.log('Found', response.results.length, 'articles');
              
              const articles = [];
              for (const page of response.results) {
                const props = page.properties;
                const title = props.Name?.title?.[0]?.plain_text || 'Untitled';
                const slug = (props.Slug?.rich_text?.[0]?.plain_text || title).toLowerCase().replace(/[^a-z0-9]+/g, '-');
                const date = props.Date?.date?.start || page.created_time.split('T')[0];
                const excerpt = props.Excerpt?.rich_text?.[0]?.plain_text || '';
                
                articles.push({ title, slug, date, excerpt });
                console.log('Added:', title);
              }
              
              if (!fs.existsSync('faith_life')) fs.mkdirSync('faith_life');
              
              const html = '<!DOCTYPE html><html><head><meta charset=\"UTF-8\"><title>Faith & Life</title></head><body><h1>Faith & Life</h1>' +
                articles.map(a => '<div><h2>' + a.title + '</h2><p>' + a.excerpt + '</p><small>' + a.date + '</small></div>').join('') +
                '</body></html>';
              
              fs.writeFileSync('faith_life/index.html', html);
              console.log('Created faith_life/index.html with', articles.length, 'articles');
            } catch (e) {
              console.error('Error:', e);
              process.exit(1);
            }
          })();
          "
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add faith_life/
          git diff --staged --quiet || (git commit -m "Sync from Notion" && git push)
