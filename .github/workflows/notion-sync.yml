name: Sync Notion to GitHub

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install @notionhq/client@latest

      - name: Create sync script
        run: |
          cat > sync.js << 'EOF'
          const { Client } = require('@notionhq/client');
          const fs = require('fs');
          const path = require('path');

          const notion = new Client({ auth: process.env.NOTION_TOKEN });
          const databaseId = process.env.NOTION_DATABASE_ID;

          async function getMarkdownFromBlocks(blockId) {
            const blocks = await notion.blocks.children.list({ block_id: blockId });
            let markdown = '';
            
            for (const block of blocks.results) {
              if (block.type === 'paragraph') {
                const text = block.paragraph.rich_text.map(t => t.plain_text).join('');
                markdown += text + '\n\n';
              } else if (block.type === 'heading_1') {
                const text = block.heading_1.rich_text.map(t => t.plain_text).join('');
                markdown += '# ' + text + '\n\n';
              } else if (block.type === 'heading_2') {
                const text = block.heading_2.rich_text.map(t => t.plain_text).join('');
                markdown += '## ' + text + '\n\n';
              } else if (block.type === 'heading_3') {
                const text = block.heading_3.rich_text.map(t => t.plain_text).join('');
                markdown += '### ' + text + '\n\n';
              } else if (block.type === 'bulleted_list_item') {
                const text = block.bulleted_list_item.rich_text.map(t => t.plain_text).join('');
                markdown += '- ' + text + '\n';
              } else if (block.type === 'numbered_list_item') {
                const text = block.numbered_list_item.rich_text.map(t => t.plain_text).join('');
                markdown += '1. ' + text + '\n';
              }
            }
            
            return markdown;
          }

          async function syncNotion() {
            try {
              console.log('Fetching database...');
              const response = await notion.databases.query({
                database_id: databaseId,
              });

              console.log('Found', response.results.length, 'pages');

              for (const page of response.results) {
                const title = page.properties.Title?.title?.[0]?.plain_text || 
                              page.properties.Name?.title?.[0]?.plain_text || 
                              'Untitled';
                
                const folder = page.properties.Folder?.select?.name || 
                               page.properties.Folder?.rich_text?.[0]?.plain_text ||
                               'faith_life';
                
                const date = page.properties.Date?.date?.start || page.created_time;

                console.log('Processing:', title);

                const content = await getMarkdownFromBlocks(page.id);

                const frontmatterLines = [
                  '---',
                  'title: "' + title.replace(/"/g, '\\"') + '"',
                  'date: ' + date,
                  '---',
                  ''
                ];
                const frontmatter = frontmatterLines.join('\n');

                const fullContent = frontmatter + '\n' + content;

                const dirPath = path.join(folder);
                if (!fs.existsSync(dirPath)) {
                  fs.mkdirSync(dirPath, { recursive: true });
                }

                const filename = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const filepath = path.join(dirPath, filename + '.md');

                fs.writeFileSync(filepath, fullContent);
                console.log('Created:', filepath);
              }

              console.log('Sync complete!');
            } catch (error) {
              console.error('Error syncing:', error);
              process.exit(1);
            }
          }

          syncNotion();
          EOF

      - name: Run sync script
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: node sync.js

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git diff --quiet && git diff --staged --quiet || (git commit -m "Sync from Notion" && git push)
