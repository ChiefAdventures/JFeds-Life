name: Sync Notion to Website

on:
  workflow_dispatch:

jobs:
  sync-notion:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm init -y
          npm install @notionhq/client@^2.2.3 notion-to-md@^3.1.0
      
      - name: Create package.json for modules
        run: |
          echo '{"type":"module"}' > package.json
          npm install @notionhq/client@^2.2.3 notion-to-md@^3.1.0
      
      - name: Create templates directory
        run: mkdir -p templates
      
      - name: Create article template
        run: |
          cat > templates/article.html << 'EOFARTICLE'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>{{TITLE}} - JFed's Life</title>
              <style>
                  :root {
                      --bg-primary: #ffffff;
                      --bg-secondary: #f8f9fa;
                      --text-primary: #212529;
                      --text-secondary: #6c757d;
                      --accent: #b8546d;
                      --accent-hover: #9a4158;
                      --border: #dee2e6;
                      --shadow: rgba(0, 0, 0, 0.1);
                  }
                  [data-theme="dark"] {
                      --bg-primary: #1a1a1a;
                      --bg-secondary: #2d2d2d;
                      --text-primary: #f8f9fa;
                      --text-secondary: #adb5bd;
                      --accent: #c97084;
                      --accent-hover: #d88798;
                      --border: #495057;
                      --shadow: rgba(0, 0, 0, 0.3);
                  }
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background-color: var(--bg-primary);
                      color: var(--text-primary);
                      line-height: 1.6;
                  }
                  header {
                      background-color: var(--bg-secondary);
                      padding: 1rem 2rem;
                      box-shadow: 0 2px 10px var(--shadow);
                  }
                  nav {
                      max-width: 1200px;
                      margin: 0 auto;
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                  }
                  .logo {
                      font-size: 1.5rem;
                      font-weight: 700;
                      color: var(--accent);
                      text-decoration: none;
                  }
                  .back-link {
                      color: var(--accent);
                      text-decoration: none;
                      font-weight: 600;
                  }
                  .back-link:hover { color: var(--accent-hover); }
                  main {
                      max-width: 800px;
                      margin: 4rem auto;
                      padding: 2rem;
                  }
                  .article-header {
                      margin-bottom: 3rem;
                      padding-bottom: 2rem;
                      border-bottom: 2px solid var(--border);
                  }
                  .article-title {
                      font-size: 2.5rem;
                      margin-bottom: 1rem;
                      color: var(--accent);
                  }
                  .article-meta {
                      color: var(--text-secondary);
                      font-size: 0.95rem;
                  }
                  .article-content {
                      font-size: 1.1rem;
                      line-height: 1.8;
                  }
                  .article-content h1, .article-content h2, .article-content h3 {
                      margin: 2rem 0 1rem;
                      color: var(--text-primary);
                  }
                  .article-content p { margin-bottom: 1.5rem; }
                  footer {
                      background-color: var(--bg-secondary);
                      padding: 2rem;
                      margin-top: 4rem;
                      text-align: center;
                  }
              </style>
          </head>
          <body>
              <header>
                  <nav>
                      <a href="/" class="logo">JFed's Life</a>
                      <a href="/faith_life" class="back-link">← Back to Faith & Life</a>
                  </nav>
              </header>
              <main>
                  <article>
                      <div class="article-header">
                          <h1 class="article-title">{{TITLE}}</h1>
                          <div class="article-meta">
                              <span>{{DATE}}</span>
                              <span> • {{CATEGORY}}</span>
                          </div>
                      </div>
                      <div class="article-content">
                          {{CONTENT}}
                      </div>
                  </article>
              </main>
              <footer>
                  <p>&copy; 2025 JFed's Life. All rights reserved.</p>
              </footer>
          </body>
          </html>
          EOFARTICLE
      
      - name: Create index template
        run: |
          cat > templates/index.html << 'EOFINDEX'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Faith & Life - JFed's Life</title>
              <style>
                  :root {
                      --bg-primary: #ffffff;
                      --bg-secondary: #f8f9fa;
                      --text-primary: #212529;
                      --text-secondary: #6c757d;
                      --accent: #b8546d;
                      --accent-hover: #9a4158;
                      --accent-secondary: #d97742;
                      --border: #dee2e6;
                      --shadow: rgba(0, 0, 0, 0.1);
                  }
                  [data-theme="dark"] {
                      --bg-primary: #1a1a1a;
                      --bg-secondary: #2d2d2d;
                      --text-primary: #f8f9fa;
                      --text-secondary: #adb5bd;
                      --accent: #c97084;
                      --accent-hover: #d88798;
                      --accent-secondary: #e89560;
                      --border: #495057;
                      --shadow: rgba(0, 0, 0, 0.3);
                  }
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                      background-color: var(--bg-primary);
                      color: var(--text-primary);
                      line-height: 1.6;
                  }
                  header {
                      background-color: var(--bg-secondary);
                      box-shadow: 0 2px 10px var(--shadow);
                      padding: 1rem 2rem;
                  }
                  nav {
                      max-width: 1200px;
                      margin: 0 auto;
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                  }
                  .logo {
                      font-size: 1.5rem;
                      font-weight: 700;
                      color: var(--accent);
                      text-decoration: none;
                  }
                  .page-hero {
                      background: linear-gradient(135deg, #b8546d 0%, #d97742 100%);
                      color: white;
                      padding: 4rem 2rem;
                      text-align: center;
                  }
                  .page-hero h1 {
                      font-size: 3rem;
                      margin-bottom: 1rem;
                  }
                  .page-hero p {
                      font-size: 1.25rem;
                      opacity: 0.95;
                  }
                  main {
                      max-width: 1200px;
                      margin: 4rem auto;
                      padding: 2rem;
                  }
                  .section-title {
                      font-size: 2rem;
                      margin-bottom: 2rem;
                      color: var(--accent);
                      border-bottom: 3px solid var(--accent);
                      padding-bottom: 0.5rem;
                  }
                  .articles-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                      gap: 2rem;
                  }
                  .article-card {
                      background-color: var(--bg-secondary);
                      padding: 2rem;
                      border-radius: 12px;
                      box-shadow: 0 4px 12px var(--shadow);
                      transition: transform 0.3s ease, box-shadow 0.3s ease;
                  }
                  .article-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 8px 20px var(--shadow);
                  }
                  .article-date {
                      font-size: 0.9rem;
                      color: var(--text-secondary);
                      margin-bottom: 0.5rem;
                  }
                  .article-card h3 {
                      font-size: 1.5rem;
                      color: var(--accent);
                      margin-bottom: 1rem;
                  }
                  .article-excerpt {
                      color: var(--text-secondary);
                      margin-bottom: 1.5rem;
                      line-height: 1.6;
                  }
                  .read-more {
                      color: var(--accent);
                      font-weight: 600;
                      text-decoration: none;
                      transition: color 0.3s ease;
                  }
                  .read-more:hover { color: var(--accent-hover); }
                  footer {
                      background-color: var(--bg-secondary);
                      padding: 3rem 2rem;
                      margin-top: 4rem;
                      text-align: center;
                  }
                  .no-articles {
                      text-align: center;
                      padding: 4rem 2rem;
                      color: var(--text-secondary);
                      font-size: 1.1rem;
                  }
              </style>
          </head>
          <body>
              <header>
                  <nav>
                      <a href="/" class="logo">JFed's Life</a>
                  </nav>
              </header>
              <section class="page-hero">
                  <h1>Faith & Life</h1>
                  <p>Reflections, insights, and stories about living with purpose and intention</p>
              </section>
              <main>
                  <h2 class="section-title">Recent Articles</h2>
                  {{ARTICLES}}
              </main>
              <footer>
                  <p>&copy; 2025 JFed's Life. All rights reserved.</p>
              </footer>
          </body>
          </html>
          EOFINDEX
      
      - name: Create sync script
        run: |
          cat > sync.mjs << 'EOFSCRIPT'
          import { Client } from '@notionhq/client';
          import { NotionToMarkdown } from 'notion-to-md';
          import fs from 'fs';
          import path from 'path';

          const notion = new Client({ auth: process.env.NOTION_TOKEN });
          const n2m = new NotionToMarkdown({ notionClient: notion });

          const articleTemplate = fs.readFileSync('templates/article.html', 'utf8');
          const indexTemplate = fs.readFileSync('templates/index.html', 'utf8');

          async function main() {
            try {
              console.log('Fetching articles from Notion...');
              
              const response = await notion.databases.query({
                database_id: process.env.NOTION_DATABASE_ID,
                filter: {
                  property: 'Published',
                  checkbox: { equals: true }
                },
                sorts: [{ property: 'Date', direction: 'descending' }]
              });

              console.log('Found', response.results.length, 'published articles');
              const articles = [];
              
              for (const page of response.results) {
                const title = page.properties.Name?.title?.[0]?.plain_text || 'Untitled';
                const slug = page.properties.Slug?.rich_text?.[0]?.plain_text || 
                             title.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                const date = page.properties.Date?.date?.start || new Date().toISOString().split('T')[0];
                const excerpt = page.properties.Excerpt?.rich_text?.[0]?.plain_text || '';
                const category = page.properties.Category?.select?.name || 'General';

                console.log('Processing:', title);

                const mdblocks = await n2m.pageToMarkdown(page.id);
                const mdString = n2m.toMarkdownString(mdblocks);
                let content = (mdString.parent || '').trim();

                let html = content
                  .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                  .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                  .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                  .replace(/\*(.*?)\*/g, '<em>$1</em>')
                  .split('\n\n').map(p => '<p>' + p.replace(/\n/g, '<br>') + '</p>').join('\n');

                articles.push({ title, slug, date, excerpt, category, content: html });

                const formattedDate = new Date(date).toLocaleDateString('en-US', { 
                  year: 'numeric', month: 'long', day: 'numeric' 
                });

                const articleHtml = articleTemplate
                  .replace(/\{\{TITLE\}\}/g, title)
                  .replace(/\{\{DATE\}\}/g, formattedDate)
                  .replace(/\{\{CATEGORY\}\}/g, category)
                  .replace(/\{\{CONTENT\}\}/g, html);

                const dir = 'faith_life';
                if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                fs.writeFileSync(path.join(dir, slug + '.html'), articleHtml);
                console.log('Created:', slug + '.html');
              }

              const articlesHtml = articles.length > 0 
                ? '<div class="articles-grid">' + articles.map(a => {
                    const fd = new Date(a.date).toLocaleDateString('en-US', { 
                      year: 'numeric', month: 'long', day: 'numeric' 
                    });
                    return '<div class="article-card"><div class="article-date">' + fd + 
                      '</div><h3>' + a.title + '</h3><p class="article-excerpt">' + a.excerpt + 
                      '</p><a href="/faith_life/' + a.slug + '" class="read-more">Read More →</a></div>';
                  }).join('') + '</div>'
                : '<p class="no-articles">No articles published yet. Check back soon!</p>';

              const indexHtml = indexTemplate.replace(/\{\{ARTICLES\}\}/g, articlesHtml);
              fs.writeFileSync('faith_life/index.html', indexHtml);
              console.log('Updated faith_life/index.html');
              console.log('Sync complete!');
            } catch (error) {
              console.error('Error:', error);
              process.exit(1);
            }
          }

          main();
          EOFSCRIPT
      
      - name: Run sync
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: node sync.mjs
      
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add faith_life/
          git diff --staged --quiet || (git commit -m "Sync from Notion" && git push)
